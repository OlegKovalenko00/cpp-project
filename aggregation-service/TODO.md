# TODO: Aggregation Service

## –í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ

### Issue #1-3: –ö–∞—Ä–∫–∞—Å –ø—Ä–æ–µ–∫—Ç–∞
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CMakeLists.txt
- [x] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (include/, src/, tests/)
- [x] –ü–æ–¥–∫–ª—é—á–∏—Ç—å PostgreSQL (libpq)
- [x] –°–æ–∑–¥–∞—Ç—å docker-compose.yml –¥–ª—è PostgreSQL

### Issue #4: –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
- [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `RawEvent` ‚Äî —Å—ã—Ä–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç metrics-service
- [x] –°—Ç—Ä—É–∫—Ç—É—Ä—ã –∞–≥—Ä–µ–≥–∞—Ç–æ–≤:
  - [x] `AggregatedPageViews`
  - [x] `AggregatedClicks`
  - [x] `AggregatedPerformance`
  - [x] `AggregatedErrors`
  - [x] `AggregatedCustomEvents`
- [x] `AggregationResult` ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤

### Issue #5: gRPC-–∫–ª–∏–µ–Ω—Ç –∫ metrics-service
- [x] –ü–æ–¥–∫–ª—é—á–∏—Ç—å proto/metrics.proto
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é gRPC stubs –≤ CMake
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `MetricsClient`:
  - [x] `fetchPageViews()`
  - [x] `fetchClicks()`
  - [x] `fetchPerformance()`
  - [x] `fetchErrors()`
  - [x] `fetchCustomEvents()`
  - [x] `fetchAllEvents()` ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Ç–∏–ø—ã

### Issue #6: –õ–æ–≥–∏–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `aggregateEvents()` ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ time bucket
- [x] `calculateAverage()` ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- [x] `calculateP95()` ‚Äî 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å
- [x] `calculateMin()` / `calculateMax()`
- [x] –ü–æ–¥—Å—á—ë—Ç unique users/sessions —á–µ—Ä–µ–∑ `unordered_set`

### Issue #7: –°—Ö–µ–º–∞ –ë–î –∏ –∑–∞–ø–∏—Å—å
- [x] –†–∞–∑–±–∏—Ç—å –Ω–∞ 5 —Ç–∞–±–ª–∏—Ü (–≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π –±–æ–ª—å—à–æ–π):
  - [x] `agg_page_views`
  - [x] `agg_clicks`
  - [x] `agg_performance`
  - [x] `agg_errors`
  - [x] `agg_custom_events`
- [x] –¢–∞–±–ª–∏—Ü–∞ `aggregation_watermark`
- [x] –ú–µ—Ç–æ–¥—ã –∑–∞–ø–∏—Å–∏: `writePageViews()`, `writeClicks()`, etc.
- [x] `writeAggregationResult()` ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ –∞–≥—Ä–µ–≥–∞—Ç—ã
- [x] UPSERT (ON CONFLICT) ‚Äî —Å—á—ë—Ç—á–∏–∫–∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–ø–∏—Å–∏
- [x] `getWatermark()` / `updateWatermark()`

### Issue #8: –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª run()
- [x] –ß–∏—Ç–∞—Ç—å watermark –∏–∑ –ë–î
- [x] –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
- [x] –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- [x] –û–±–Ω–æ–≤–ª—è—Ç—å watermark
- [x] –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ–∫–∞ metrics-service –Ω–µ –≥–æ—Ç–æ–≤)

---

## –í –ø—Ä–æ—Ü–µ—Å—Å–µ üîÑ

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å metrics-service
- [ ] –ü–æ–¥–∫–ª—é—á–∏—Ç—å `MetricsClient` –≤ `Aggregator::run()`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ gRPC –≤—ã–∑–æ–≤—ã
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ metrics-service

---

## –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è üìã

### Issue #9: –¶–∏–∫–ª –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ (—Ç–∞–π–º–µ—Ä)
- [ ] –ó–∞–ø—É—Å–∫ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- [ ] Graceful shutdown (SIGTERM/SIGINT)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### Issue #11: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: —Å–æ–±—ã—Ç–∏—è ‚Üí –∞–≥—Ä–µ–≥–∞—Ü–∏—è ‚Üí –ë–î
- [ ] –¢–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º metrics-service

### Issue #11: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: —Å–æ–±—ã—Ç–∏—è ‚Üí –∞–≥—Ä–µ–≥–∞—Ü–∏—è ‚Üí –ë–î
- [ ] –¢–µ—Å—Ç UPSERT –ª–æ–≥–∏–∫–∏
- [ ] –¢–µ—Å—Ç watermark

### Issue #12: Dockerfile –∏ CI
- [ ] –°–æ–∑–¥–∞—Ç—å multi-stage Dockerfile
- [ ] Health check endpoint
- [ ] GitHub Actions –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤

### Issue #13: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ Prometheus (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (JSON)

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **metrics-service –Ω–µ –≥–æ—Ç–æ–≤** ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
2. **–ù–µ—Ç retry –ª–æ–≥–∏–∫–∏** ‚Äî –ø—Ä–∏ –æ—à–∏–±–∫–µ gRPC –∑–∞–ø—Ä–æ—Å –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
3. **–û–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è** ‚Äî –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è
